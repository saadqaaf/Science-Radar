<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Research Trend Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        :root {
            --bg-color: #f0fdf4; 
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #4b5563;
            --primary: #16a34a; 
            --border: #e5e7eb;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; padding: 2rem 1rem; background: var(--bg-color); color: var(--text-main); }
        .container { max-width: 1400px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 2rem; }
        h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 12px; color: #111827;}
        .update-time { color: var(--text-muted); font-size: 0.875rem; font-weight: 500;}
        
        .info-card {
            background: #dcfce7; border-left: 4px solid var(--primary); padding: 1rem 1.5rem;
            border-radius: 8px; margin-bottom: 2rem; color: #166534; font-size: 0.95rem; line-height: 1.5;
        }

        .tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;}
        .tab-btn { 
            background: var(--card-bg); border: 1px solid var(--border); padding: 0.75rem 1.5rem; 
            cursor: pointer; font-size: 1rem; font-weight: 600; border-radius: 9999px; 
            transition: all 0.2s ease; color: var(--text-muted); display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border); }
        .cloud-container { width: 100%; height: 75vh; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer;}
        canvas { width: 100%; height: 100%; }
        .empty-state, .loading-state { text-align: center; color: var(--text-muted); font-size: 1.1rem; display: none; position: absolute; }

        #interactive-popup { 
            position: absolute; background: rgba(17, 24, 39, 0.98); color: white; padding: 16px; 
            border-radius: 8px; display: none; max-width: 350px; z-index: 50; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); pointer-events: auto;
        }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #374151; padding-bottom: 8px;}
        .close-btn { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; padding: 0;}
        .close-btn:hover { color: white; }
        #popup-content { font-size: 0.9rem; color: #d1d5db; display: flex; flex-direction: column; gap: 8px; }
        a { color: #60a5fa; text-decoration: none; word-break: break-all;}
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="16" height="12" rx="2" ry="2"></rect><line x1="2" y1="9" x2="2" y2="15"></line><line x1="10" y1="12" x2="18" y2="12"></line><line x1="14" y1="8" x2="14" y2="16"></line></svg>
                Energy Research Trend Analyzer
            </h1>
            <div class="update-time" id="update-time">Syncing latest publications...</div>
        </header>

        <div class="info-card">
            <strong>‚ÑπÔ∏è About this Dashboard:</strong> This tool runs daily to scrape newly published papers from top Energy and Battery journals. 
            Click on any word in the clouds below to see its specific frequency and associated publication DOIs.
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('accumulative')">üìä Accumulative Trends</button>
            <button class="tab-btn" onclick="switchTab('new-words')">‚ú® Emerging New Words</button>
        </div>

        <div id="interactive-popup">
            <div class="popup-header">
                <strong id="popup-word" style="color: #6ee7b7; font-size: 1.2rem; text-transform: capitalize;">Word</strong>
                <button class="close-btn" onclick="closePopup()">‚úñ</button>
            </div>
            <div id="popup-content"></div>
        </div>

        <div id="accumulative" class="tab-content active">
            <div class="card">
                <div class="cloud-container" id="container-accum">
                    <div id="accum-loading" class="loading-state">Rendering complex data...</div>
                    <canvas id="canvas-accum"></canvas>
                </div>
            </div>
        </div>

        <div id="new-words" class="tab-content">
            <div class="card">
                <div class="cloud-container" id="container-new">
                    <div id="new-loading" class="loading-state">Rendering complex data...</div>
                    <canvas id="canvas-new"></canvas>
                    <div id="new-empty-state" class="empty-state">
                        No entirely new vocabulary discovered today.<br>Check back tomorrow after new publications arrive!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalData = null;

        function closePopup() {
            document.getElementById('interactive-popup').style.display = 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            closePopup();
            if (globalData) {
                // Short timeout allows UI to paint the tab switch before locking up to draw canvas
                setTimeout(renderClouds, 50); 
            }
        }

        function positionPopup(event) {
            const popup = document.getElementById('interactive-popup');
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            
            if (left + 350 > window.innerWidth) {
                left = event.pageX - 365;
            }
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.style.display = 'block';
        }

        async function loadData() {
            try {
                const response = await fetch('dashboard_data.json?' + new Date().getTime());
                globalData = await response.json();
                document.getElementById('update-time').innerText = "Last synced: " + globalData.last_updated + " UTC";
                
                renderClouds();

                window.addEventListener('resize', () => {
                    clearTimeout(window.resizeTimer);
                    window.resizeTimer = setTimeout(renderClouds, 300); // Increased debounce for performance
                });
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('update-time').innerText = "Waiting for initial GitHub Action data sync...";
            }
        }

        function renderClouds() {
            if (!globalData) return;
            const popup = document.getElementById('interactive-popup');

            // --- Render Accumulative Cloud ---
            if (document.getElementById('accumulative').classList.contains('active')) {
                const canvasAcc = document.getElementById('canvas-accum');
                canvasAcc.width = canvasAcc.parentElement.offsetWidth;
                canvasAcc.height = canvasAcc.parentElement.offsetHeight;
                
                // PERFORMANCE OPTIMIZATION: Dynamic Normalization
                const accumEntries = Object.entries(globalData.cumulative);
                // Sort to get the most frequent words first
                accumEntries.sort((a, b) => b[1] - a[1]);
                
                // Only take the top 100 words to prevent browser freezing
                const topWords = accumEntries.slice(0, 100);
                
                // Find the highest count to set a ceiling for our math
                const maxCount = topWords.length > 0 ? topWords[0][1] : 1;
                
                // Scale words dynamically. Max size is 120px, Min size is 14px.
                let accList = topWords.map(([word, count]) => {
                    let calculatedSize = Math.max(14, (count / maxCount) * 120);
                    return [word, calculatedSize];
                }); 

                WordCloud(canvasAcc, { 
                    list: accList, 
                    weightFactor: 1, // We already did the math above
                    gridSize: 16,    // PERFORMANCE OPTIMIZATION: Increases spacing checks, drastically reducing render time
                    shrinkToFit: true, // Prevents infinite loops if words are too big
                    color: 'random-dark', 
                    fontFamily: 'Inter',
                    click: function(item, dimension, event) {
                        if (!item) return;
                        const word = item[0];
                        // Get the real, unscaled count straight from the JSON
                        const realCount = globalData.cumulative[word]; 
                        
                        document.getElementById('popup-word').innerText = word;
                        document.getElementById('popup-content').innerHTML = `<strong>Total historical occurrences:</strong> <span style="color:#fff;">${realCount}</span>`;
                        
                        positionPopup(event);
                    }
                });
            }

            // --- Render New Words Cloud ---
            if (document.getElementById('new-words').classList.contains('active')) {
                const canvasNew = document.getElementById('canvas-new');
                const emptyState = document.getElementById('new-empty-state');
                const newWordsEntries = Object.entries(globalData.new_words);

                if (newWordsEntries.length === 0) {
                    canvasNew.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    canvasNew.style.display = 'block';
                    emptyState.style.display = 'none';
                    canvasNew.width = canvasNew.parentElement.offsetWidth;
                    canvasNew.height = canvasNew.parentElement.offsetHeight;
                    
                    // Same performance optimization for new words
                    newWordsEntries.sort((a, b) => b[1].count - a[1].count);
                    const topNewWords = newWordsEntries.slice(0, 100);
                    const maxNewCount = topNewWords.length > 0 ? topNewWords[0][1].count : 1;
                    
                    let newList = topNewWords.map(([word, data]) => {
                        let calculatedSize = Math.max(16, (data.count / maxNewCount) * 100);
                        return [word, calculatedSize];
                    });
                    
                    WordCloud(canvasNew, { 
                        list: newList, 
                        weightFactor: 1, 
                        gridSize: 16,
                        shrinkToFit: true,
                        color: () => ['#16a34a', '#0ea5e9', '#8b5cf6', '#f59e0b'][Math.floor(Math.random() * 4)], 
                        fontFamily: 'Inter',
                        click: function(item, dimension, event) {
                            if (!item) return;
                            const word = item[0];
                            const data = globalData.new_words[word];
                            const dois = data.dois.map(doi => `<a href="https://doi.org/${doi}" target="_blank">${doi}</a>`).join("");
                            
                            document.getElementById('popup-word').innerText = word;
                            document.getElementById('popup-content').innerHTML = `
                                <div><strong>Today's Count:</strong> <span style="color:#fff;">${data.count}</span></div>
                                <div style="margin-top:4px;"><strong>Source DOIs:</strong></div>
                                <div style="display: flex; flex-direction: column; gap: 6px;">${dois}</div>
                            `;
                            
                            positionPopup(event);
                        }
                    });
                }
            }
        }

        document.addEventListener('click', function(event) {
            const popup = document.getElementById('interactive-popup');
            if (event.target.tagName !== 'CANVAS' && !popup.contains(event.target)) {
                closePopup();
            }
        });

        loadData();
    </script>
</body>
</html>
