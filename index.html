<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Trends Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --border: #e5e7eb;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 2rem 1rem; 
            background: var(--bg-color); 
            color: var(--text-main);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Styles */
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.025em; }
        .update-time { color: var(--text-muted); font-size: 0.875rem; }

        /* Modern Tabs */
        .tabs { 
            display: flex; 
            justify-content: center; 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        .tab-btn { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            padding: 0.75rem 1.5rem; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 500;
            border-radius: 9999px; /* Pill shape */
            transition: all 0.2s ease;
            color: var(--text-muted);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }

        /* Content Areas */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Layouts */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        /* Canvas Container */
        .cloud-container { 
            width: 100%; 
            height: 50vh; 
            position: relative; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas { width: 100%; height: 100%; }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.1rem;
            display: none;
        }

        /* Modern Tooltip */
        #tooltip { 
            position: absolute; 
            background: rgba(17, 24, 39, 0.95); 
            color: white; 
            padding: 12px 16px; 
            border-radius: 8px; 
            display: none; 
            pointer-events: none; 
            max-width: 300px; 
            z-index: 50; 
            font-size: 0.875rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px);
        }

        /* Modern Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { 
            background-color: #f8fafc; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em;
            padding: 1rem; 
            border-bottom: 2px solid var(--border);
        }
        td { padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }
        
        a { color: var(--primary); text-decoration: none; font-weight: 500;}
        a:hover { text-decoration: underline; color: var(--primary-hover);}
        
        .doi-list { display: flex; flex-direction: column; gap: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Research Trends Dashboard</h1>
            <div class="update-time" id="update-time">Loading real-time data...</div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('accumulative')">Accumulative Trends</button>
            <button class="tab-btn" onclick="switchTab('new-words')">Emerging New Words</button>
        </div>

        <div id="tooltip"></div>

        <div id="accumulative" class="tab-content active">
            <div class="card">
                <div class="cloud-container" id="container-accum">
                    <canvas id="canvas-accum"></canvas>
                </div>
            </div>
            <div class="card table-container">
                <table>
                    <thead><tr><th>Vocabulary</th><th>Total Occurrences</th></tr></thead>
                    <tbody id="table-accum"></tbody>
                </table>
            </div>
        </div>

        <div id="new-words" class="tab-content">
            <div class="card">
                <div class="cloud-container" id="container-new">
                    <canvas id="canvas-new"></canvas>
                    <div id="new-empty-state" class="empty-state">
                        No entirely new words discovered today.<br>Check back tomorrow after new papers are published!
                    </div>
                </div>
            </div>
            <div class="card table-container">
                <table>
                    <thead><tr><th>Emerging Word</th><th>Today's Count</th><th>Source Paper DOIs</th></tr></thead>
                    <tbody id="table-new"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let globalData = null;

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            if (globalData) renderClouds(); 
        }

        async function loadData() {
            try {
                // Add cache-busting to ensure we always get the latest JSON
                const response = await fetch('dashboard_data.json?' + new Date().getTime());
                globalData = await response.json();
                document.getElementById('update-time').innerText = "Last synced: " + globalData.last_updated;
                
                populateTables();
                renderClouds();

                window.addEventListener('resize', () => {
                    clearTimeout(window.resizeTimer);
                    window.resizeTimer = setTimeout(renderClouds, 200); // Debounce resize
                });
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('update-time').innerText = "Waiting for initial data sync...";
            }
        }

        function populateTables() {
            // Accumulative Table
            const accTbody = document.getElementById('table-accum');
            accTbody.innerHTML = '';
            for (const [word, count] of Object.entries(globalData.cumulative)) {
                accTbody.innerHTML += `<tr><td><strong>${word}</strong></td><td>${count}</td></tr>`;
            }

            // New Words Table
            const newTbody = document.getElementById('table-new');
            newTbody.innerHTML = '';
            const newWordsEntries = Object.entries(globalData.new_words);
            
            if (newWordsEntries.length === 0) {
                newTbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#6b7280;">No new data to display.</td></tr>`;
                return;
            }

            for (const [word, data] of newWordsEntries) {
                let doiLinks = data.dois.map(doi => `<a href="https://doi.org/${doi}" target="_blank">${doi}</a>`).join('');
                newTbody.innerHTML += `<tr><td><strong>${word}</strong></td><td>${data.count}</td><td><div class="doi-list">${doiLinks}</div></td></tr>`;
            }
        }

        function renderClouds() {
            if (!globalData) return;
            const tooltip = document.getElementById('tooltip');

            // Setup Accumulative Cloud
            if (document.getElementById('accumulative').classList.contains('active')) {
                const canvasAcc = document.getElementById('canvas-accum');
                canvasAcc.width = canvasAcc.parentElement.offsetWidth;
                canvasAcc.height = canvasAcc.parentElement.offsetHeight;
                
                let accList = Object.entries(globalData.cumulative).map(([k, v]) => [k, v * 15]); 
                
                WordCloud(canvasAcc, { 
                    list: accList, 
                    weightFactor: 1, 
                    color: 'random-dark', 
                    fontFamily: 'Inter',
                    backgroundColor: 'transparent' 
                });
            }

            // Setup New Words Cloud
            if (document.getElementById('new-words').classList.contains('active')) {
                const canvasNew = document.getElementById('canvas-new');
                const emptyState = document.getElementById('new-empty-state');
                const newWordsEntries = Object.entries(globalData.new_words);

                if (newWordsEntries.length === 0) {
                    canvasNew.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    canvasNew.style.display = 'block';
                    emptyState.style.display = 'none';
                    canvasNew.width = canvasNew.parentElement.offsetWidth;
                    canvasNew.height = canvasNew.parentElement.offsetHeight;
                    
                    let newList = newWordsEntries.map(([k, v]) => [k, v.count * 30]);
                    
                    WordCloud(canvasNew, { 
                        list: newList, 
                        weightFactor: 1, 
                        color: () => ['#4f46e5', '#10b981', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 4)], 
                        fontFamily: 'Inter',
                        backgroundColor: 'transparent',
                        hover: function(item, dimension, event) {
                            if (!item) { tooltip.style.display = 'none'; return; }
                            const word = item[0];
                            const dois = globalData.new_words[word].dois.join("<br>");
                            tooltip.innerHTML = `<div style="margin-bottom:4px; font-weight:bold; color:#a5b4fc;">${word}</div>Source DOIs:<br>${dois}`;
                            tooltip.style.left = event.pageX + 15 + 'px';
                            tooltip.style.top = event.pageY + 15 + 'px';
                            tooltip.style.display = 'block';
                        }
                    });
                    
                    canvasNew.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                }
            }
        }

        loadData();
    </script>
</body>
</html>
